# PowerShell script to build the PostgreSQL database
# Reads server information from .namespace.json or .namespace file in user's home directory
# 
# Prerequisites:
# 1. PostgreSQL client tools (psql) must be installed and in PATH
# 2. If execution policy blocks scripts: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# Check if psql is available
if (-not (Get-Command psql -ErrorAction SilentlyContinue)) {
    Write-Error "psql command not found. Please ensure PostgreSQL client tools are installed and in your PATH."
    Write-Error "Download from: https://www.postgresql.org/download/windows/"
    exit 1
}

# Get the user's home directory
$jsonFile = Join-Path $env:USERPROFILE ".@(Model.Name).json"
$legacyFile = Join-Path $env:USERPROFILE ".@(Model.Name)"

# Initialize variables with defaults
$dbType = "postgresql"
$server = "localhost"
$port = "5432"
$database = "@(Model.Name)"
$username = "postgres"
$password = ""

# Try to read JSON format first
if (Test-Path $jsonFile) {
    Write-Host "Reading configuration from: $jsonFile"
    $jsonContent = Get-Content $jsonFile -Raw | ConvertFrom-Json
    
    # Get the default datasource
    if ($jsonContent.datasources.default) {
        $defaultDs = $jsonContent.datasources.default
        
        if ($defaultDs.dbtype) { $dbType = $defaultDs.dbtype }
        if ($defaultDs.hostname) { $server = $defaultDs.hostname }
        if ($defaultDs.port) { $port = $defaultDs.port }
        if ($defaultDs.database) { $database = $defaultDs.database }
        if ($defaultDs.username) { $username = $defaultDs.username }
        if ($defaultDs.password) { $password = $defaultDs.password }
    }
}
# Fall back to legacy format
elseif (Test-Path $legacyFile) {
    Write-Host "Reading configuration from legacy file: $legacyFile"
    $namespaceContent = Get-Content $legacyFile -Raw
    $namespaceParts = $namespaceContent.Trim().Split(':')
    
    if ($namespaceParts.Count -lt 4) {
        Write-Error "Invalid namespace file format. Expected: dbtype:server:port:database[:username:password]"
        Write-Error "Found: $namespaceContent"
        exit 1
    }
    
    $dbType = $namespaceParts[0]
    $server = $namespaceParts[1]
    $port = $namespaceParts[2]
    $database = $namespaceParts[3]
    
    if ($namespaceParts.Count -ge 5) {
        $username = $namespaceParts[4]
    }
    if ($namespaceParts.Count -ge 6) {
        $password = $namespaceParts[5]
    }
}
else {
    Write-Error "Configuration file not found. Looking for:"
    Write-Error "  - $jsonFile"
    Write-Error "  - $legacyFile"
    Write-Error "Please create a .@(Model.Name).json file in your home directory"
    exit 1
}

# Validate that this is for PostgreSQL
if ($dbType -ne "postgresql" -and $dbType -ne "pgsql") {
    Write-Error "This script is for PostgreSQL databases. Namespace file specifies: $dbType"
    exit 1
}

Write-Host "Connecting to PostgreSQL: $server`:$port"
Write-Host "Database: $database"
Write-Host "Username: $username"

# Set PGPASSWORD environment variable if password is provided
if ($password) {
    $env:PGPASSWORD = $password
    Write-Host "Using PostgreSQL authentication with username: $username"
}
else {
    Write-Host "Using PostgreSQL default authentication"
}

# Execute the database creation script
Write-Host "Executing database creation script..."
$dbCreateScript = ".\@(Model.Name + ".database.create.generated.sql")"
if (-not (Test-Path $dbCreateScript)) {
    Write-Error "Database creation script not found: $dbCreateScript"
    exit 1
}

psql --host=$server --port=$port --dbname=postgres --username=$username --file="$dbCreateScript"

if ($LASTEXITCODE -ne 0) {
    Write-Error "Failed to execute database creation script: $dbCreateScript"
    Write-Error "Check your PostgreSQL connection settings and ensure the server is running."
    exit $LASTEXITCODE
}

# Execute all other SQL files
@foreach( string sourceFile in Model.sourceFiles) {
    if (sourceFile == Model.Name + ".database.create.generated.sql") {
        continue;
    }
    else if (sourceFile.Contains("build")) {
        continue;
    }
    else {
        <text>
Write-Host "Executing: @sourceFile"
$sqlFile = ".\@sourceFile"
if (-not (Test-Path $sqlFile)) {
    Write-Warning "SQL file not found, skipping: $sqlFile"
    continue
}

psql --host=$server --port=$port --dbname=$database --username=$username --file="$sqlFile"
if ($LASTEXITCODE -ne 0) {
    Write-Error "Failed to execute: $sqlFile"
    Write-Error "Check the SQL file for syntax errors and ensure the database connection is working."
    exit $LASTEXITCODE
}
        </text>
    }
}

Write-Host "Database build completed successfully!"