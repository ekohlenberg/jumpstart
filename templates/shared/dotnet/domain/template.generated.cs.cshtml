@{
    string namespaceName = @Model.Namespace;
    string className = @Model.DomainObj; 
    string schemaName = @Model.SchemaName; 
    string tableName = @Model.TableName; 
    string classLabel = @Model.Label; 
}

@using System;
@using System.Reflection;
@using System.Collections.Generic;
@using jumpstart;

using System;
using System.Reflection;
using System.Collections.Generic;

namespace @namespaceName
{
    [ClassInfo("@classLabel")]
    public partial class @className : BaseObject
    {
        public @(className)(BaseObject baseObject) : base(baseObject)
        {
            Initialize();
        }

        protected override void Initialize()
        {
            // Default initializer
            domainName = "@(className)";
            tableName = "@schemaName.@tableName";
            schemaName = "@schemaName";
            tableBaseName = "@tableName";
            auditTableName = "history.@(schemaName)_@(tableName)";

            @foreach (var attr in Model.Attributes)
            {
                if (attr.RWK == "1")
                {
            <text>
            rwk.Add("@attr.Name");
            </text>
                }
    
                
            }

            @foreach (var attr in Model.Attributes)
            {
                
            <text>
            _defaults["@attr.Name"] = default(@attr.DotNetType);
            </text>
                
            }
        }

        @foreach (var attr in Model.Attributes)
        {
            <text>
            [ColumnInfo("@attr.Label", "@attr.FkObject", "@attr.FkType")]
            public @attr.DotNetType @attr.Name
            {
                get
                {
                    @attr.DotNetType _@attr.Name;
                    @{
                        if (attr.DotNetType == "string")
                        {
                            <text>
                            _@attr.Name = string.Empty;
                            </text>
                        } 
                        else
                        {
                            <text>
                             _@attr.Name = default(@attr.DotNetType);
                             </text>
                        }
                    }
                    
                    try
                    {
                        if(this.ContainsKey("@attr.Name"))
                        {
                        _@attr.Name = Convert.@(attr.ConvertMethod)(this["@attr.Name"].ToString());
                        }
                    }
                    catch(Exception )
                    {
                        //Logger.Error($"Error getting @attr.Name: {e.Message}");
                        _@attr.Name = default(@attr.DotNetType);
                    }
                    return _@attr.Name;
                }
                set
                {
                   
                    this["@attr.Name"] = value;
                }
            }
            </text>
        }
    }

    public partial class @(className)History : @className
    {
        protected override void Initialize()
        {
            // History object initializer - override table name and add foreign key
            base.Initialize();
            
            domainName = "@(className)History";
            tableName = "history.@(schemaName)_@(tableName)";
            tableBaseName = "@(schemaName)_@(tableName)";
          

            // Add the foreign key to the original object
            rwk.Add("@(tableName)_id");
            _defaults["@(tableName)_id"] = default(long);
        }

        // Foreign key property to the original object
        [ColumnInfo("@(classLabel) ID")]
        public long @(tableName)_id
        {
            get
            {
                long _@(tableName)_id = default(long);
                
                try
                {
                    if(this.ContainsKey("@(tableName)_id"))
                    {
                        _@(tableName)_id = Convert.ToInt64(this["@(tableName)_id"].ToString());
                    }
                }
                catch(Exception)
                {
                    //Logger.Error($"Error getting @(tableName)_id: {e.Message}");
                    _@(tableName)_id = default(long);
                }
                return _@(tableName)_id;
            }
            set
            {
                this["@(tableName)_id"] = value;
            }
        }
    }

    // View class that extends the base domain object with RWK columns from foreign key joins
    public class @(Model.DomainObj)View : @(Model.DomainObj)
    {
        @{
            // Find foreign key relationships
            var foreignKeys = new List<MetaAttribute>();
            foreach(var attr in Model.Attributes)
            {
                if (!string.IsNullOrEmpty(attr.FkObject))
                {
                    foreignKeys.Add(attr);
                }
            }
            
            // Track used aliases to avoid conflicts (same logic as query template)
            var usedAliases = new HashSet<string>();
            
            foreach(var fk in foreignKeys)
            {
                // Find the foreign key object
                var fkObject = (MetaObject)null;
                foreach(var obj in Model.Model.Objects)
                {
                    if (obj.TableName == fk.FkObject)
                    {
                        fkObject = obj;
                        break;
                    }
                }
                if (fkObject != null)
                {
                    // Create unique alias based on foreign key column name (same logic as query template)
                    var aliasBase = fk.Name;
                    if (aliasBase.EndsWith("_id"))
                    {
                        aliasBase = aliasBase.Substring(0, aliasBase.Length - 3);
                    }
                    
                    // Ensure alias is unique
                    var alias = aliasBase;
                    var counter = 1;
                    while (usedAliases.Contains(alias))
                    {
                        alias = aliasBase + "_" + counter;
                        counter++;
                    }
                    usedAliases.Add(alias);
                    string aliasLabel = !string.IsNullOrEmpty(alias)  ? char.ToUpper(alias[0]) + alias.Substring(1)  : alias;
                    // Add RWK columns from the foreign key table
                    foreach(var fkAttr in fkObject.Attributes)
                    {
                        if (fkAttr.RWK == "1")
                        {
                            string fkAttrName = alias + "_" + fkAttr.Name;
                             <text>
            [ColumnInfo("@aliasLabel @fkAttr.Label")]
            public @fkAttr.DotNetType @fkAttrName
            {
                get
                {
                    @fkAttr.DotNetType _@fkAttrName;
                    @{
                        if (fkAttr.DotNetType == "string")
                        {
                            <text>
                            _@fkAttrName = string.Empty;
                            </text>
                        } 
                        else
                        {
                            <text>
                             _@fkAttrName = default(@fkAttr.DotNetType);
                             </text>
                        }
                    }
                    
                    try
                    {
                        if(this.ContainsKey("@fkAttrName"))
                        {
                        _@fkAttrName = Convert.@(fkAttr.ConvertMethod)(this["@fkAttrName"].ToString());
                        }
                    }
                    catch(Exception )
                    {
                        //Logger.Error($"Error getting @fkAttrName: {e.Message}");
                        _@fkAttrName = default(@fkAttr.DotNetType);
                    }
                    return _@fkAttrName;
                }
                set
                {
                   
                    this["@fkAttrName"] = value;
                }
            }
            </text>
                        }
                    }
                }
            }
        }
    }
}
