using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using @Model.Namespace;

namespace @Model.Namespace
{
    public partial class @(Model.DomainObj)Test : BaseTest
    {
        public static async Task testInsert()
        {
            var @(Model.DomainVar) = new @(Model.DomainObj)();

            @foreach (var attr in Model.Attributes)
            {
                if (attr.IsGlobal()) continue;
                
                if (attr.Name.EndsWith("id"))
                {
                    if (!string.IsNullOrEmpty(attr.FkObject))
                    {
                    <text>
                    @(Model.DomainVar).@attr.Name = BaseTest.getLastId("@attr.FkObject");
                    </text>
                    }
                }
                else
                {
                    var testDataSet = "random";
                    if (!string.IsNullOrEmpty(attr.TestDataSet))
                    {
                        testDataSet = attr.TestDataSet;
                    }
                    <text>
                    @(Model.DomainVar).@attr.Name = Convert.@(attr.ConvertMethod)(BaseTest.getTestData(@(Model.DomainVar), "@attr.SqlDataType", TestDataType.@testDataSet));
                    </text>
                }
            }
            @{
            <text>
                Console.WriteLine("Testing @(Model.DomainObj) API insert: " + @(Model.DomainVar).ToString());
                await PostAsync("@(Model.DomainObj)", @(Model.DomainVar));
                BaseTest.addLastId("@(Model.TableName)", @(Model.DomainVar).id);
            </text>
            }
        }

        public static async Task testUpdate()
        {
            long lastId = BaseTest.getLastId("@(Model.DomainObj)");
            var @(Model.DomainVar) = await GetByIdAsync<@(Model.DomainObj)>("@(Model.DomainObj)", lastId);

            @foreach (var attr in Model.Attributes)
            {
                if (attr.IsGlobal()) continue;

                if (attr.Name.EndsWith("id"))
                {
                    if (!string.IsNullOrEmpty(attr.FkObject))
                    {
                        <text>
                            @(Model.DomainVar).@attr.Name = BaseTest.getLastId("@attr.FkObject");
                        </text>
                    }
                }
                else
                {
                    var testDataSet = "random";
                    if (!string.IsNullOrEmpty(attr.TestDataSet))
                    {
                        testDataSet = attr.TestDataSet;
                    }
                    <text>
                        @(Model.DomainVar).@attr.Name = (@attr.DotNetType) BaseTest.getTestData(@(Model.DomainVar), "@attr.SqlDataType", TestDataType.@testDataSet);
                    </text>
                }
            }
            @{
            <text>
                Console.WriteLine("Testing @(Model.DomainObj) API update: " + @(Model.DomainVar).ToString());
                await PutAsync("@(Model.DomainObj)", lastId, @(Model.DomainVar));
            </text>
            }
        }
    }
}
