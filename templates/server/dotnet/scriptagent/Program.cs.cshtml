using System.Net;
using System.Net.Sockets;
using @Model.Namespace;

// Configuration for dynamic port binding
const int StartPort = 5100;
const int EndPort = 5200;
const int MaxRetries = 100;

int boundPort = 0;
IPAddress boundIP = Config.getNetworkInterfaceIP();
var builder = WebApplication.CreateBuilder(args);

// Try to find an available port
for (int port = StartPort; port <= EndPort && port < StartPort + MaxRetries; port++)
{
    try
    {
        // Configure Kestrel to listen on the resolved network interface
        builder.WebHost.UseUrls($"http://{boundIP}:{port}");

        // Test if port is available by trying to bind
        using (var socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp))
        {
            socket.Bind(new IPEndPoint(boundIP, port));
        }

        boundPort = port;
        Console.WriteLine($"ScriptAgent will bind to IP: {boundIP}, Port: {boundPort}");
        break;
    }
    catch (SocketException)
    {
        // Port is in use, try next port
        continue;
    }
}

if (boundPort == 0)
{
    Console.WriteLine($"ERROR: Could not find available port in range {StartPort}-{EndPort}");
    Environment.Exit(1);
}

// Add services to the container.
builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

builder.Services.AddCors(options =>
{
    options.AddPolicy("Access-Control-Allow-Origin",
                    builder =>
                    {
                        builder.WithOrigins("*")
                           .AllowAnyHeader().AllowAnyMethod().AllowAnyOrigin();
                    });

});

var app = builder.Build();

// Register notification callback
NotificationRegistrar.Register();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}
app.UseCors("Access-Control-Allow-Origin");

//app.UseHttpsRedirection();

//app.UseAuthorization();

app.MapControllers();

// Register shutdown handler to set server status to offline
app.Lifetime.ApplicationStopping.Register(() =>
{
    try
    {
        Console.WriteLine("ScriptAgent: Application is shutting down, setting server status to Offline...");
        var serverNode = @(Model.Namespace).core.ScriptAgentLogic.thisServerNode;
        if (serverNode != null && serverNode.id > 0)
        {
            @(Model.Namespace).core.ScriptAgentLogic.Create().unregister(serverNode.id);
            Console.WriteLine("ScriptAgent: Server node unregistered, status updated to Offline");
        }
        else
        {
            Console.WriteLine("ScriptAgent: Server node not registered, skipping status update");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error setting server status to Offline during shutdown: {ex.Message}");
    }
});

// Register agent after successful binding
var registrationTask = Task.Run(async () =>
{
    try
    {
        // Wait a moment for the server to fully start
        await Task.Delay(1000);
        
        // Call registration callback
        await RegisterScriptAgent(boundIP, boundPort);
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error during scriptagent registration: {ex.Message}");
    }
});

app.Run();

// Registration callback function
static async Task RegisterScriptAgent(IPAddress boundIP, int port)
{
    // Get SessionInfo singleton and populate it with system information
    var sessionInfo = SessionInfo.Instance;
    Util.PopulateSessionInfo(sessionInfo);
    
    // Add agent-specific information to the session
    sessionInfo.SetValue("ScriptAgentIPAddress", boundIP.ToString());
    sessionInfo.SetValue("ScriptAgentPort", port.ToString());
    sessionInfo.SetValue("ScriptAgentURL", $"http://{boundIP}:{port}");
    
    // Set ServerNode keys that are used in registration
    sessionInfo.SetValue("ServerNodeIPAddress", boundIP.ToString());
    sessionInfo.SetValue("ServerNodeURL", $"http://{boundIP}:{port}");
    
    var computerName   = sessionInfo.GetValue("ComputerName", Environment.MachineName);
    var scriptAgentId = $"{computerName}:{port}";
    
    Console.WriteLine($"==============================================");
    Console.WriteLine($"ScriptAgent Registration");
    Console.WriteLine($"==============================================");
    Console.WriteLine($"ScriptAgent ID: {agentId}");
    Console.WriteLine($"Computer Name: {computerName}");
    Console.WriteLine($"IP Address: {boundIP}");
    Console.WriteLine($"Port: {port}");
    Console.WriteLine($"URL: http://{boundIP}:{port}");
    Console.WriteLine($"User: {sessionInfo.GetValue("UserName", "Unknown")}");
    Console.WriteLine($"Domain: {sessionInfo.GetValue("UserDomain", "Unknown")}");
    Console.WriteLine($"==============================================");
    

    
    
    var registrationData = new ServerNode        {
            
            hostname = computerName,
            server_node_type_id = (long)ServerNode.ServerNodeType.Agent,
            ip_address = sessionInfo.GetValue("ServerNodeIPAddress"),
            port = port,
            url = sessionInfo.GetValue("ServerNodeURL"),
            username = sessionInfo.GetValue("UserName"),
            user_domain = sessionInfo.GetValue("UserDomain"),
            os_name = sessionInfo.GetValue("OSName"),
            os_version = sessionInfo.GetValue("OSVersion"),
            architecture = sessionInfo.GetValue("Architecture"),
            registered_at = DateTime.UtcNow,
            server_node_status_id = (long)ServerNode.ServerNodeStatus.Online,
            is_active = 1,
            created_by = Environment.UserName,
            
        };

        @(Model.Namespace).core.ScriptAgentLogic.Create().register(registrationData);
        
    
}
