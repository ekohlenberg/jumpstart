using Microsoft.AspNetCore.Mvc;
using System;
using System.Threading.Tasks;
using @Model.Namespace;

namespace @(Model.Namespace).Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class NotificationController : ControllerBase
    {
        private readonly IEventAggregator _eventAggregator;

        public NotificationController(IEventAggregator eventAggregator)
        {
            _eventAggregator = eventAggregator;
        }

        // POST api/Notification/publish
        [HttpPost("publish")]
        public async Task<ActionResult> Publish([FromBody] NotificationRequest request)
        {
            try
            {
                Logger.Debug($"NotificationController.Publish: Received notification request");
                
                if (request == null)
                {
                    Logger.Debug("NotificationController.Publish: Request is null");
                    return BadRequest("Notification request cannot be null");
                }

                Logger.Debug($"NotificationController.Publish: DomainObjectName={request.DomainObjectName}, InstanceId={request.InstanceId}");

                if (string.IsNullOrWhiteSpace(request.DomainObjectName))
                {
                    Logger.Debug("NotificationController.Publish: DomainObjectName is null or whitespace");
                    return BadRequest("DomainObjectName is required");
                }

                if (string.IsNullOrWhiteSpace(request.JsonData))
                {
                    Logger.Debug("NotificationController.Publish: JsonData is null or whitespace");
                    return BadRequest("JsonData is required");
                }

                Logger.Debug($"NotificationController.Publish: Publishing event for {request.DomainObjectName}[{request.InstanceId}]");
                
                await _eventAggregator.PublishAsync(
                    request.DomainObjectName,
                    request.InstanceId,
                    request.JsonData
                );

                Logger.Debug($"NotificationController.Publish: Successfully published notification for {request.DomainObjectName}[{request.InstanceId}]");
                Logger.Debug($"JsonData={request.JsonData}");
                return Ok();
            }
            catch (Exception ex)
            {
                Logger.Error($"Error publishing notification: {ex.Message}", ex);
                return StatusCode(500, "Internal server error while publishing notification");
            }
        }
    }

    /// <summary>
    /// Request model for publishing object updates
    /// </summary>
    public class NotificationRequest
    {
        /// <summary>
        /// Domain object name (e.g., "Execution", "Workflow", "Agent")
        /// </summary>
        public string DomainObjectName { get; set; }

        /// <summary>
        /// Instance ID of the domain object
        /// </summary>
        public long InstanceId { get; set; }

        /// <summary>
        /// JSON string representation of the entire updated BaseObject
        /// </summary>
        public string JsonData { get; set; }
    }
}

