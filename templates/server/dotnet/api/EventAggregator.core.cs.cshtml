using Microsoft.AspNetCore.SignalR;
using System;
using System.Threading.Tasks;
using @Model.Namespace;
using @(Model.Namespace).Hubs;

namespace @(Model.Namespace)
{
    /// <summary>
    /// Interface for event aggregation service
    /// </summary>
    public interface IEventAggregator
    {
        /// <summary>
        /// Publishes an object update event to all subscribed clients
        /// </summary>
        /// <param name="domainObjectName">Domain object name (e.g., "Execution", "Workflow", "Agent")</param>
        /// <param name="instanceId">Instance ID of the domain object</param>
        /// <param name="jsonData">JSON string representation of the entire updated BaseObject</param>
        Task PublishAsync(string domainObjectName, long instanceId, string jsonData);
    }

    /// <summary>
    /// Event aggregator service that routes property updates to SignalR clients
    /// </summary>
    public class EventAggregator : IEventAggregator
    {
        private readonly IHubContext<NotificationHub> _hubContext;

        public EventAggregator(IHubContext<NotificationHub> hubContext)
        {
            _hubContext = hubContext;
        }

        /// <summary>
        /// Publishes an object update event to all clients subscribed to the domain object type
        /// </summary>
        public async Task PublishAsync(string domainObjectName, long instanceId, string jsonData)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(domainObjectName))
                {
                    throw new ArgumentException("Domain object name cannot be null or empty", nameof(domainObjectName));
                }

                if (string.IsNullOrWhiteSpace(jsonData))
                {
                    throw new ArgumentException("JSON data cannot be null or empty", nameof(jsonData));
                }

                var message = new PropertyUpdateMessage
                {
                    DomainObjectName = domainObjectName,
                    InstanceId = instanceId,
                    JsonData = jsonData,
                    Timestamp = DateTime.UtcNow
                };

                // Broadcast to all clients in the domain object group
                await _hubContext.Clients.Group(domainObjectName).SendAsync("PropertyUpdated", message);

                Logger.Info($"Published object update: {domainObjectName}[{instanceId}]");
            }
            catch (Exception ex)
            {
                Logger.Error($"Error publishing event: {ex.Message}", ex);
                throw;
            }
        }
    }

    /// <summary>
    /// Message structure for object update notifications
    /// </summary>
    public class PropertyUpdateMessage
    {
        /// <summary>
        /// Domain object name (e.g., "Execution", "Workflow", "Agent")
        /// </summary>
        public string DomainObjectName { get; set; }

        /// <summary>
        /// Instance ID of the domain object
        /// </summary>
        public long InstanceId { get; set; }

        /// <summary>
        /// JSON string representation of the entire updated BaseObject
        /// </summary>
        public string JsonData { get; set; }

        /// <summary>
        /// Timestamp when the update occurred
        /// </summary>
        public DateTime Timestamp { get; set; }
    }
}

